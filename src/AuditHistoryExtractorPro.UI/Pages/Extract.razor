@page "/extract"
@using AuditHistoryExtractorPro.Application.UseCases.ExtractAudit
@using AuditHistoryExtractorPro.Domain.ValueObjects
@using AuditHistoryExtractorPro.Domain.Entities
@using AuditHistoryExtractorPro.Domain.Interfaces
@using AuditHistoryExtractorPro.UI.Services
@using AuditHistoryExtractorPro.UI.ViewModels
@inject ILogger<Extract> Logger
@inject NavigationManager Navigation
@inject IAuditService AuditService

<PageTitle>Nueva Extracci√≥n - Audit History Extractor Pro</PageTitle>

<h1 style="color: #0078D4; margin-bottom: 30px; font-size: 36px;">üîΩ Nueva Extracci√≥n</h1>

<div class="form-container">
    <div class="form-section">
        <h2 style="color: #0078D4; margin-bottom: 20px;">üìã Criterios de Extracci√≥n</h2>
        
        <div class="form-group">
            <label>Nombre de la Entidad:</label>
            <input type="text" @bind="_vm.EntityName" placeholder="account, contact, etc." class="form-input" />
        </div>

        <div class="form-group">
            <label>ID del Registro (opcional):</label>
            <input type="text" @bind="_vm.RecordId" placeholder="00000000-0000-0000-0000-000000000000" class="form-input" />
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Fecha Inicio:</label>
                <input type="date" @bind="_vm.StartDate" class="form-input" />
            </div>
            
            <div class="form-group">
                <label>Fecha Fin:</label>
                <input type="date" @bind="_vm.EndDate" class="form-input" />
            </div>
        </div>

        <div class="form-group">
            <label>Operaciones espec√≠ficas (opcional):</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="_vm.IncludeCreate" />
                    <span>Crear</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" @bind="_vm.IncludeUpdate" />
                    <span>Actualizar</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" @bind="_vm.IncludeDelete" />
                    <span>Eliminar</span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>L√≠mite de registros:</label>
            <input type="number" @bind="_vm.MaxRecords" min="1" max="10000" class="form-input" />
        </div>

        @if (isLoading)
        {
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: @(_vm.Progress)%"></div>
                </div>
                <p style="text-align: center; color: #0078D4; margin-top: 10px;">
                    Extrayendo... @(_vm.Progress)% completado
                </p>
                @if (!string.IsNullOrWhiteSpace(_vm.StatusMessage))
                {
                    <p style="text-align: center; color: #605E5C; margin-top: 4px; font-size: 13px;">
                        @_vm.StatusMessage
                    </p>
                }
            </div>
        }

        @if (isLoading)
        {
            <div class="loading-indicator" role="status" aria-live="polite">
                <span class="loading-spinner" aria-hidden="true"></span>
                <span>Cargando...</span>
            </div>
        }

        @if (!string.IsNullOrEmpty(alertMessage))
        {
            <div class="@(isAlertError ? "message-error" : "message-success")">
                @alertMessage
                @if (_vm.RecordsExtracted > 0)
                {
                    <p><strong>Registros extra√≠dos: @_vm.RecordsExtracted</strong></p>
                }
            </div>
        }

        <div class="button-group">
            <button class="btn-ms btn-ms-success" @onclick="HandleExtractOnClick" disabled="@isLoading">
                @(isLoading ? "Extrayendo..." : "Extraer")
            </button>
            @if (isLoading)
            {
                <button class="btn-secondary" @onclick="CancelExtraction">
                    ‚õî Cancelar
                </button>
            }
            <button class="btn-secondary" @onclick="@(() => Navigation.NavigateTo("/"))">
                ‚¨ÖÔ∏è Volver al Dashboard
            </button>
            @if (_vm.RecordsExtracted > 0 && !isLoading)
            {
                <button class="btn-export" @onclick="@(() => Navigation.NavigateTo("/export"))">
                    Exportar
                </button>
            }
        </div>
    </div>
</div>

@code {
    private readonly ExtractPageViewModel _vm = new();
    private bool isLoading;
    private string alertMessage = string.Empty;
    private bool isAlertError;

    private async Task HandleExtractOnClick()
    {
        if (string.IsNullOrWhiteSpace(_vm.EntityName))
        {
            ShowAlert("‚ö†Ô∏è Selecciona o ingresa una entidad antes de extraer.", true);
            return;
        }

        isLoading = true;
        _vm.Progress = 0;
        _vm.StatusMessage = string.Empty;
        _vm.RecordsExtracted = 0;
        _vm.ExtractionCts?.Dispose();
        _vm.ExtractionCts = new CancellationTokenSource();
        alertMessage = string.Empty;
        isAlertError = false;

        try
        {
            var progress = new Progress<ExtractionProgress>(p =>
            {
                _vm.Progress = (int)Math.Round(p.PercentComplete, MidpointRounding.AwayFromZero);
                _vm.StatusMessage = string.IsNullOrWhiteSpace(p.Status)
                    ? $"Entidad actual: {p.CurrentEntity}"
                    : p.Status;
                InvokeAsync(StateHasChanged);
            });

            var result = await AuditService.ExtractAuditHistoryAsync(
                new ExtractInputModel
                {
                    EntityName = _vm.EntityName,
                    RecordId = _vm.RecordId,
                    StartDate = _vm.StartDate,
                    EndDate = _vm.EndDate,
                    IncludeCreate = _vm.IncludeCreate,
                    IncludeUpdate = _vm.IncludeUpdate,
                    IncludeDelete = _vm.IncludeDelete,
                    MaxRecords = _vm.MaxRecords
                },
                progress,
                _vm.ExtractionCts.Token);

            if (result.Success)
            {
                _vm.RecordsExtracted = result.RecordsExtracted;
                ShowAlert(result.Message, false);
                _vm.Progress = 100;
            }
            else
            {
                ShowAlert(result.Message, true);
            }
        }
        catch (OperationCanceledException)
        {
            ShowAlert("‚ö†Ô∏è Extracci√≥n cancelada por el usuario.", true);
            _vm.StatusMessage = string.Empty;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error durante la extracci√≥n");
            ShowAlert($"‚ùå Error inesperado: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
            _vm.ExtractionCts?.Dispose();
            _vm.ExtractionCts = null;
        }
    }

    private void CancelExtraction()
    {
        if (isLoading)
        {
            _vm.ExtractionCts?.Cancel();
        }
    }

    private void ShowAlert(string message, bool isError)
    {
        alertMessage = message;
        isAlertError = isError;
    }
}

<style>
    .form-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .form-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    label {
        display: block;
        color: #323130;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #EDEBE9;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .form-input:focus {
        outline: none;
        border-color: #0078D4;
    }

    .checkbox-group {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: normal;
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .progress-container {
        margin: 20px 0;
    }

    .progress-bar {
        width: 100%;
        height: 30px;
        background: #EDEBE9;
        border-radius: 15px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #0078D4 0%, #50E6FF 100%);
        transition: width 0.3s;
    }

    .message-success {
        background: #DFF6DD;
        border-left: 4px solid #107C10;
        padding: 15px;
        border-radius: 4px;
        color: #107C10;
        margin: 20px 0;
    }

    .message-error {
        background: #FDE7E9;
        border-left: 4px solid #E81123;
        padding: 15px;
        border-radius: 4px;
        color: #A80000;
        margin: 20px 0;
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        flex-wrap: wrap;
    }

    .loading-indicator {
        margin: 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #323130;
        font-weight: 600;
    }

    .loading-spinner {
        width: 18px;
        height: 18px;
        border: 3px solid #D1D1D1;
        border-top-color: #00A4EF;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
