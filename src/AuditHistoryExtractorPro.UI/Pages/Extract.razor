@page "/extract"
@using AuditHistoryExtractorPro.Application.UseCases.ExtractAudit
@using AuditHistoryExtractorPro.Domain.ValueObjects
@using AuditHistoryExtractorPro.Domain.Entities
@using AuditHistoryExtractorPro.Domain.Interfaces
@using AuditHistoryExtractorPro.UI.Services
@using AuditHistoryExtractorPro.UI.ViewModels
@inject ILogger<Extract> Logger
@inject NavigationManager Navigation
@inject ExtractPageCoordinator ExtractPageCoordinator

<PageTitle>Nueva Extracci√≥n - Audit History Extractor Pro</PageTitle>

<h1 style="color: #0078D4; margin-bottom: 30px; font-size: 36px;">üîΩ Nueva Extracci√≥n</h1>

<div class="form-container">
    <div class="form-section">
        <h2 style="color: #0078D4; margin-bottom: 20px;">üìã Criterios de Extracci√≥n</h2>
        
        <div class="form-group">
            <label>Nombre de la Entidad:</label>
            <input type="text" @bind="_vm.EntityName" placeholder="account, contact, etc." class="form-input" />
        </div>

        <div class="form-group">
            <label>ID del Registro (opcional):</label>
            <input type="text" @bind="_vm.RecordId" placeholder="00000000-0000-0000-0000-000000000000" class="form-input" />
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Fecha Inicio:</label>
                <input type="date" @bind="_vm.StartDate" class="form-input" />
            </div>
            
            <div class="form-group">
                <label>Fecha Fin:</label>
                <input type="date" @bind="_vm.EndDate" class="form-input" />
            </div>
        </div>

        <div class="form-group">
            <label>Operaciones espec√≠ficas (opcional):</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="_vm.IncludeCreate" />
                    <span>Crear</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" @bind="_vm.IncludeUpdate" />
                    <span>Actualizar</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" @bind="_vm.IncludeDelete" />
                    <span>Eliminar</span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>L√≠mite de registros:</label>
            <input type="number" @bind="_vm.MaxRecords" min="1" max="10000" class="form-input" />
        </div>

        @if (_vm.IsExtracting)
        {
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: @(_vm.Progress)%"></div>
                </div>
                <p style="text-align: center; color: #0078D4; margin-top: 10px;">
                    Extrayendo... @(_vm.Progress)% completado
                </p>
                @if (!string.IsNullOrWhiteSpace(_vm.StatusMessage))
                {
                    <p style="text-align: center; color: #605E5C; margin-top: 4px; font-size: 13px;">
                        @_vm.StatusMessage
                    </p>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(_vm.Message))
        {
            <div class="@(_vm.IsError ? "message-error" : "message-success")">
                @_vm.Message
                @if (_vm.RecordsExtracted > 0)
                {
                    <p><strong>Registros extra√≠dos: @_vm.RecordsExtracted</strong></p>
                }
            </div>
        }

        <div class="button-group">
            <button class="btn-primary" @onclick="StartExtraction" disabled="@_vm.IsExtracting">
                @(_vm.IsExtracting ? "‚è≥ Extrayendo..." : "üöÄ Iniciar Extracci√≥n")
            </button>
            @if (_vm.IsExtracting)
            {
                <button class="btn-secondary" @onclick="CancelExtraction">
                    ‚õî Cancelar
                </button>
            }
            <button class="btn-secondary" @onclick="@(() => Navigation.NavigateTo("/"))">
                ‚¨ÖÔ∏è Volver al Dashboard
            </button>
            @if (_vm.RecordsExtracted > 0 && !_vm.IsExtracting)
            {
                <button class="btn-success" @onclick="@(() => Navigation.NavigateTo("/export"))">
                    üìä Ir a Exportar ‚Üí
                </button>
            }
        </div>
    </div>
</div>

@code {
    private readonly ExtractPageViewModel _vm = new();

    private async Task StartExtraction()
    {
        _vm.IsExtracting = true;
        _vm.Progress = 0;
        _vm.StatusMessage = string.Empty;
        _vm.Message = string.Empty;
        _vm.IsError = false;
        _vm.RecordsExtracted = 0;
        _vm.ExtractionCts?.Dispose();
        _vm.ExtractionCts = new CancellationTokenSource();

        try
        {
            var progress = new Progress<ExtractionProgress>(p =>
            {
                _vm.Progress = (int)Math.Round(p.PercentComplete, MidpointRounding.AwayFromZero);
                _vm.StatusMessage = string.IsNullOrWhiteSpace(p.Status)
                    ? $"Entidad actual: {p.CurrentEntity}"
                    : p.Status;
                InvokeAsync(StateHasChanged);
            });

            var result = await ExtractPageCoordinator.ExecuteAsync(
                new ExtractInputModel
                {
                    EntityName = _vm.EntityName,
                    RecordId = _vm.RecordId,
                    StartDate = _vm.StartDate,
                    EndDate = _vm.EndDate,
                    IncludeCreate = _vm.IncludeCreate,
                    IncludeUpdate = _vm.IncludeUpdate,
                    IncludeDelete = _vm.IncludeDelete,
                    MaxRecords = _vm.MaxRecords
                },
                progress,
                _vm.ExtractionCts.Token);

            if (result.Success)
            {
                _vm.RecordsExtracted = result.RecordsExtracted;
                _vm.Message = result.Message;
                _vm.IsError = false;
                _vm.Progress = 100;
            }
            else
            {
                _vm.Message = result.Message;
                _vm.IsError = true;
            }
        }
        catch (OperationCanceledException)
        {
            _vm.Message = "‚ö†Ô∏è Extracci√≥n cancelada por el usuario.";
            _vm.IsError = true;
            _vm.StatusMessage = string.Empty;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error durante la extracci√≥n");
            _vm.Message = $"‚ùå Error inesperado: {ex.Message}";
            _vm.IsError = true;
        }
        finally
        {
            _vm.IsExtracting = false;
            _vm.ExtractionCts?.Dispose();
            _vm.ExtractionCts = null;
        }
    }

    private void CancelExtraction()
    {
        if (_vm.IsExtracting)
        {
            _vm.ExtractionCts?.Cancel();
        }
    }
}

<style>
    .form-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .form-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    label {
        display: block;
        color: #323130;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #EDEBE9;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .form-input:focus {
        outline: none;
        border-color: #0078D4;
    }

    .checkbox-group {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: normal;
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .progress-container {
        margin: 20px 0;
    }

    .progress-bar {
        width: 100%;
        height: 30px;
        background: #EDEBE9;
        border-radius: 15px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #0078D4 0%, #50E6FF 100%);
        transition: width 0.3s;
    }

    .message-success {
        background: #DFF6DD;
        border-left: 4px solid #107C10;
        padding: 15px;
        border-radius: 4px;
        color: #107C10;
        margin: 20px 0;
    }

    .message-error {
        background: #FDE7E9;
        border-left: 4px solid #E81123;
        padding: 15px;
        border-radius: 4px;
        color: #A80000;
        margin: 20px 0;
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        flex-wrap: wrap;
    }

    .btn-primary, .btn-secondary, .btn-success {
        padding: 14px 28px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #0078D4;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: #106EBE;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
    }

    .btn-primary:disabled {
        background: #A19F9D;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #EDEBE9;
        color: #323130;
    }

    .btn-secondary:hover {
        background: #E1DFDD;
        transform: translateY(-2px);
    }

    .btn-success {
        background: #107C10;
        color: white;
    }

    .btn-success:hover {
        background: #0E6B0E;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 124, 16, 0.3);
    }
</style>
