@page "/settings"
@using AuditHistoryExtractorPro.Domain.Interfaces
@using AuditHistoryExtractorPro.Domain.ValueObjects
@using AuditHistoryExtractorPro.Infrastructure.Authentication
@using DataverseServiceClient = Microsoft.PowerPlatform.Dataverse.Client.ServiceClient
@using DomainAuthenticationType = AuditHistoryExtractorPro.Domain.ValueObjects.AuthenticationType
@using Microsoft.Xrm.Sdk.Messages
@using Microsoft.Xrm.Sdk.Metadata
@inject NavigationManager Navigation
@inject AuthenticationConfiguration AuthConfig
@inject IServiceProvider ServiceProvider

<PageTitle>Configuraci√≥n - Audit History Extractor Pro</PageTitle>

<h1 style="color: #0078D4; margin-bottom: 30px; font-size: 36px;">‚öôÔ∏è Configuraci√≥n</h1>

<div class="settings-container">
    <!-- Pesta√±as -->
    <div class="tabs">
        <button class="tab @(_activeTab == 0 ? "active" : "")" @onclick="ActivateDataverseTab">
            üíæ Dataverse
        </button>
        <button class="tab @(_activeTab == 1 ? "active" : "")" @onclick="ActivateAccountsTab">
            üë• M√∫ltiples Cuentas
        </button>
        <button class="tab @(_activeTab == 2 ? "active" : "")" @onclick="ActivateAdvancedTab">
            üîß Avanzado
        </button>
    </div>

    <!-- Mensajes -->
    @if (!string.IsNullOrEmpty(_message))
    {
        <div class="@(_messageType == "success" ? "message-success" : _messageType == "error" ? "message-error" : "message-info")">
            @_message
        </div>
    }

    <!-- Contenido de las pesta√±as -->
    <div class="tab-content">
        @if (_activeTab == 0)
        {
            <!-- Pesta√±a Dataverse -->
            <div class="settings-section">
                <h2 style="color: #0078D4; margin-bottom: 20px;">üì° Configuraci√≥n de Conexi√≥n</h2>
                
                <div class="form-group">
                    <label>URL del Entorno:</label>
                    <input type="text" @bind="_environmentUrl" 
                           placeholder="https://yourorg.crm.dynamics.com" 
                           class="form-input" />
                    <small>URL de tu entorno de Dataverse</small>
                </div>

                <div class="form-group">
                    <label>Tipo de Autenticaci√≥n:</label>
                    <select @bind="_authType" class="form-input">
                        <option value="oauth2">OAuth2 (Azure AD - Interactivo)</option>
                        <option value="client_secret">Client Secret</option>
                        <option value="certificate">Certificate</option>
                        <option value="managed_identity">Managed Identity (Azure)</option>
                    </select>
                </div>

                @if (_authType == "oauth2" || _authType == "client_secret")
                {
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tenant ID:</label>
                            <input type="text" @bind="_tenantId" 
                                   placeholder="00000000-0000-0000-0000-000000000000" 
                                   class="form-input" />
                        </div>

                        <div class="form-group">
                            <label>Client ID (Application ID):</label>
                            <input type="text" @bind="_clientId" 
                                   placeholder="00000000-0000-0000-0000-000000000000" 
                                   class="form-input" />
                        </div>
                    </div>

                    @if (_authType == "oauth2")
                    {
                        <small>
                            Si no tienes App Registration propia, deja Tenant/Client en blanco y se usar√° el AppId p√∫blico de Microsoft.
                        </small>
                    }
                }

                @if (_authType == "oauth2")
                {
                    <div class="form-group">
                        <label>Flujo OAuth:</label>
                        <select @bind="_oauthFlow" class="form-input">
                            <option value="device_code">Device Code Flow (recomendado para Blazor)</option>
                            <option value="interactive">Login interactivo del sistema (local)</option>
                        </select>
                    </div>
                }

                @if (_authType == "client_secret")
                {
                    <div class="form-group">
                        <label>Client Secret:</label>
                        <input type="password" @bind="_clientSecret" class="form-input" />
                        <small style="color: #E81123;">‚ö†Ô∏è Ser√° almacenado temporalmente. Usar Azure Key Vault en producci√≥n.</small>
                    </div>
                }

                @if (_authType == "certificate")
                {
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ruta del Certificado:</label>
                            <input type="text" @bind="_certificatePath" 
                                   placeholder="C:\certs\certificate.pfx" 
                                   class="form-input" />
                        </div>

                        <div class="form-group">
                            <label>Contrase√±a del Certificado:</label>
                            <input type="password" @bind="_certificatePassword" class="form-input" />
                        </div>
                    </div>
                }

                <div class="button-group">
                    <button class="btn-primary" @onclick="SaveConfiguration">
                        üíæ Guardar Configuraci√≥n
                    </button>
                    <button class="btn-info" @onclick="TestConnection" disabled="@_isTesting">
                        @(_isTesting ? "‚è≥ Probando..." : "‚úì Probar Conexi√≥n")
                    </button>
                    <button class="btn-info" @onclick="LoadMetadata" disabled="@_isLoadingMetadata || _isTesting">
                        @(_isLoadingMetadata ? "‚è≥ Cargando metadatos..." : "üìö Cargar Metadatos")
                    </button>
                    <button class="btn-secondary" @onclick="ShowConfigYaml">
                        üìÑ Ver YAML
                    </button>
                </div>

                @if (_authType == "oauth2" && !string.IsNullOrWhiteSpace(_deviceCodeUserCode))
                {
                    <div class="message-info" style="margin-top: 12px;">
                        <strong>C√≥digo de acceso:</strong> @_deviceCodeUserCode<br />
                        Abre <strong>microsoft.com/devicelogin</strong> e ingresa este c√≥digo para completar el login.
                    </div>
                }

                @if (_availableEntities.Any())
                {
                    <div class="performance-stats" style="margin-top: 20px;">
                        <h3 style="color: #0078D4; margin-bottom: 15px;">üß† Metadatos Dataverse</h3>

                        <div class="stats-grid-small">
                            <div class="stat-item">
                                <span class="stat-label">Entidades cargadas:</span>
                                <span class="stat-value">@_availableEntities.Count</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Atributos cargados:</span>
                                <span class="stat-value">@_availableAttributes.Count</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Acciones auditables:</span>
                                <span class="stat-value">@_availableActions.Count</span>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label>Entidad para revisar atributos:</label>
                            <select class="form-input" value="@_selectedMetadataEntity" @onchange="OnMetadataEntityChanged">
                                @foreach (var entity in _availableEntities)
                                {
                                    <option value="@entity">@entity</option>
                                }
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Atributos (primeros 100):</label>
                                <div style="max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #EDEBE9; border-radius: 4px; padding: 10px;">
                                    @if (_availableAttributes.Any())
                                    {
                                        @foreach (var attributeName in _availableAttributes.Take(100))
                                        {
                                            <div style="font-size: 13px; color: #323130; margin-bottom: 4px;">‚Ä¢ @attributeName</div>
                                        }
                                    }
                                    else
                                    {
                                        <div style="font-size: 13px; color: #605E5C;">No hay atributos para mostrar.</div>
                                    }
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Acciones auditables:</label>
                                <div style="max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #EDEBE9; border-radius: 4px; padding: 10px;">
                                    @foreach (var action in _availableActions)
                                    {
                                        <div style="font-size: 13px; color: #323130; margin-bottom: 4px;">‚Ä¢ @action</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (_showYaml)
                {
                    <div class="yaml-preview">
                        <h3 style="color: #0078D4; margin-bottom: 15px;">üìÑ Configuraci√≥n YAML</h3>
                        <pre>@_generatedYaml</pre>
                        <button class="btn-secondary" style="margin-top: 15px;" @onclick="CloseYamlPreview">
                            ‚úï Cerrar
                        </button>
                    </div>
                }
            </div>
        }
        else if (_activeTab == 1)
        {
            <!-- Pesta√±a M√∫ltiples Cuentas -->
            <div class="settings-section">
                <h2 style="color: #0078D4; margin-bottom: 20px;">üë• Administrar Cuentas</h2>
                <p style="color: #605E5C; margin-bottom: 20px;">
                    Puedes guardar m√∫ltiples configuraciones para diferentes entornos de Dataverse.
                </p>

                @if (_savedAccounts.Any())
                {
                    <div class="table-container">
                        <table class="accounts-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>URL</th>
                                    <th>Tipo Auth</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var account in _savedAccounts)
                                {
                                    <tr>
                                        <td><strong>@account.Name</strong></td>
                                        <td>@account.Url</td>
                                        <td>
                                            <span class="badge">@account.AuthType</span>
                                        </td>
                                        <td>
                                            <button class="btn-action btn-edit" @onclick="@(() => LoadAccount(account))">
                                                ‚úèÔ∏è Editar
                                            </button>
                                            <button class="btn-action btn-delete" @onclick="@(() => DeleteAccount(account))">
                                                üóëÔ∏è Eliminar
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state-small">
                        <p>üìã No hay cuentas guardadas. Agrega una nueva cuenta abajo.</p>
                    </div>
                }

                <div style="margin-top: 30px; padding: 25px; background: #F3F9FD; border-radius: 8px; border-left: 4px solid #0078D4;">
                    <h3 style="color: #0078D4; margin-bottom: 15px;">‚ûï Agregar Nueva Cuenta</h3>
                    <div class="form-group">
                        <label>Nombre de esta Configuraci√≥n:</label>
                        <input type="text" @bind="_accountName" 
                               placeholder="Producci√≥n, Testing, Dev, etc." 
                               class="form-input" />
                        <small>Dale un nombre para identificar esta cuenta</small>
                    </div>

                    <button class="btn-success" @onclick="AddAccount">
                        ‚ûï Guardar como Nueva Cuenta
                    </button>
                </div>
            </div>
        }
        else if (_activeTab == 2)
        {
            <!-- Pesta√±a Avanzado -->
            <div class="settings-section">
                <h2 style="color: #0078D4; margin-bottom: 20px;">üîß Configuraci√≥n Avanzada</h2>
                
                <h3 style="color: #323130; margin: 30px 0 15px 0;">‚ö° Rendimiento</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Solicitudes Paralelas M√°ximas:</label>
                        <input type="number" @bind="_maxParallelRequests" 
                               min="1" max="20" 
                               class="form-input" />
                        <small>N√∫mero de consultas simult√°neas a Dataverse (1-20)</small>
                    </div>

                    <div class="form-group">
                        <label>Tama√±o de P√°gina:</label>
                        <input type="number" @bind="_pageSize" 
                               min="100" max="10000" step="100" 
                               class="form-input" />
                        <small>Registros por p√°gina (100-10000)</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label-large">
                        <input type="checkbox" @bind="_enableCaching" />
                        <span>üîÑ Habilitar Cach√©</span>
                    </label>
                </div>

                @if (_enableCaching)
                {
                    <div class="form-group" style="margin-left: 30px;">
                        <label>Duraci√≥n del Cach√© (minutos):</label>
                        <input type="number" @bind="_cacheDuration" 
                               min="1" max="1440" 
                               class="form-input" style="max-width: 200px;" />
                    </div>
                }

                <h3 style="color: #323130; margin: 40px 0 15px 0;">üîê Azure Key Vault</h3>
                
                <div class="form-group">
                    <label class="checkbox-label-large">
                        <input type="checkbox" @bind="_enableKeyVault" />
                        <span>üîë Usar Azure Key Vault</span>
                    </label>
                    <small style="display: block; margin-left: 30px; color: #605E5C;">
                        Almacena secretos de forma segura en Azure Key Vault
                    </small>
                </div>

                @if (_enableKeyVault)
                {
                    <div class="form-group" style="margin-left: 30px;">
                        <label>URL del Key Vault:</label>
                        <input type="text" @bind="_keyVaultUrl" 
                               placeholder="https://your-vault.vault.azure.net/" 
                               class="form-input" />
                    </div>
                }

                <div class="performance-stats">
                    <h3 style="color: #0078D4; margin-bottom: 15px;">üìä Configuraci√≥n Actual</h3>
                    <div class="stats-grid-small">
                        <div class="stat-item">
                            <span class="stat-label">Solicitudes Paralelas:</span>
                            <span class="stat-value">@_maxParallelRequests</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Tama√±o de P√°gina:</span>
                            <span class="stat-value">@_pageSize</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Cach√©:</span>
                            <span class="stat-value">@(_enableCaching ? $"‚úì {_cacheDuration} min" : "‚úó Deshabilitado")</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Key Vault:</span>
                            <span class="stat-value">@(_enableKeyVault ? "‚úì Habilitado" : "‚úó Deshabilitado")</span>
                        </div>
                    </div>
                </div>

                <div class="button-group" style="margin-top: 30px;">
                    <button class="btn-primary" @onclick="SaveAdvancedSettings">
                        üíæ Guardar Configuraci√≥n Avanzada
                    </button>
                    <button class="btn-secondary" @onclick="ResetToDefaults">
                        üîÑ Restaurar Valores por Defecto
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private int _activeTab = 0;
    private string _message = string.Empty;
    private string _messageType = "info"; // success, error, info
    private bool _isTesting = false;
    private bool _isLoadingMetadata = false;
    private bool _showYaml = false;
    private string _generatedYaml = string.Empty;

    // Conexi√≥n b√°sica
    private string _environmentUrl = "";
    private string _authType = "oauth2";
    private string _tenantId = "";
    private string _clientId = "";
    private string _clientSecret = "";
    private string _certificatePath = "";
    private string _certificatePassword = "";
    private string _oauthFlow = "device_code";
    private string _deviceCodeUserCode = string.Empty;
    private string _deviceCodeMessage = string.Empty;

    // M√∫ltiples cuentas
    private string _accountName = "";
    private List<SavedAccount> _savedAccounts = new();

    // Configuraci√≥n avanzada
    private int _maxParallelRequests = 10;
    private int _pageSize = 5000;
    private bool _enableCaching = true;
    private int _cacheDuration = 30;
    private bool _enableKeyVault = false;
    private string _keyVaultUrl = "";
    private readonly List<string> _availableEntities = new();
    private readonly List<string> _availableAttributes = new();
    private readonly List<string> _availableActions = Enum.GetNames<OperationType>().ToList();
    private string _selectedMetadataEntity = string.Empty;

    protected override void OnInitialized()
    {
        LoadSavedConfiguration();
    }

    private void ActivateDataverseTab()
    {
        _activeTab = 0;
        StateHasChanged();
    }

    private void ActivateAccountsTab()
    {
        _activeTab = 1;
        StateHasChanged();
    }

    private void ActivateAdvancedTab()
    {
        _activeTab = 2;
        StateHasChanged();
    }

    private void LoadSavedConfiguration()
    {
        // TODO: Cargar cuentas guardadas desde config.yaml o base de datos
        _savedAccounts = new List<SavedAccount>();
    }

    private void SaveConfiguration()
    {
        if (string.IsNullOrWhiteSpace(_environmentUrl))
        {
            ShowMessage("Por favor ingresa la URL del entorno", "error");
            return;
        }

        try
        {
            // Aqu√≠ guardar√≠as en config.yaml
            _generatedYaml = GenerateYamlConfig();
            ShowMessage("‚úì Configuraci√≥n guardada correctamente", "success");
            StateHasChanged();
        }
        catch (Exception)
        {
            ShowMessage("‚ùå Error al guardar la configuraci√≥n", "error");
        }
    }

    private async Task TestConnection()
    {
        if (string.IsNullOrWhiteSpace(_environmentUrl))
        {
            ShowMessage("Por favor configura la URL del entorno primero", "error");
            return;
        }

        _isTesting = true;
        _deviceCodeUserCode = string.Empty;
        _deviceCodeMessage = string.Empty;
        ShowMessage("Probando conexi√≥n con Dataverse...", "info");
        StateHasChanged();

        try
        {
            SyncAuthConfigurationFromForm();

            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));
            var client = await CreateServiceClientAsync(cts.Token);
            var authProvider = BuildAuthenticationProvider();

            _isTesting = false;
            ShowMessage(
                $"‚úì Conexi√≥n exitosa con Dataverse ({authProvider.GetAuthenticationType()})",
                "success");
        }
        catch (Exception ex)
        {
            _isTesting = false;
            ShowMessage($"‚ùå Error de conexi√≥n: {ex.Message}", "error");
        }
    }

    private async Task LoadMetadata()
    {
        if (string.IsNullOrWhiteSpace(_environmentUrl))
        {
            ShowMessage("Por favor configura la URL del entorno primero", "error");
            return;
        }

        _isLoadingMetadata = true;
        ShowMessage("Cargando metadatos de Dataverse...", "info");
        StateHasChanged();

        try
        {
            SyncAuthConfigurationFromForm();

            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(60));
            var client = await CreateServiceClientAsync(cts.Token);

            var request = new RetrieveAllEntitiesRequest
            {
                EntityFilters = EntityFilters.Entity,
                RetrieveAsIfPublished = true
            };

            var response = await Task.Run(
                () => (RetrieveAllEntitiesResponse)client.Execute(request),
                cts.Token);

            var entities = response.EntityMetadata?
                .Select(e => e.LogicalName)
                .Where(name => !string.IsNullOrWhiteSpace(name))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(name => name, StringComparer.OrdinalIgnoreCase)
                .ToList() ?? new List<string>();

            _availableEntities.Clear();
            _availableEntities.AddRange(entities);

            _selectedMetadataEntity = _availableEntities.FirstOrDefault() ?? string.Empty;
            await LoadSelectedEntityAttributes(client, cts.Token);

            ShowMessage(
                $"‚úì Metadatos cargados: {_availableEntities.Count} entidades y {_availableAttributes.Count} atributos en '{_selectedMetadataEntity}'",
                "success");
        }
        catch (Exception ex)
        {
            _availableEntities.Clear();
            _availableAttributes.Clear();
            _selectedMetadataEntity = string.Empty;
            ShowMessage($"‚ùå No fue posible cargar metadatos: {ex.Message}", "error");
        }
        finally
        {
            _isLoadingMetadata = false;
            StateHasChanged();
        }
    }

    private async Task OnMetadataEntityChanged(ChangeEventArgs args)
    {
        _selectedMetadataEntity = args.Value?.ToString() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(_selectedMetadataEntity))
        {
            _availableAttributes.Clear();
            return;
        }

        _isLoadingMetadata = true;
        StateHasChanged();

        try
        {
            SyncAuthConfigurationFromForm();

            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(45));
            var client = await CreateServiceClientAsync(cts.Token);
            await LoadSelectedEntityAttributes(client, cts.Token);
        }
        catch (Exception ex)
        {
            _availableAttributes.Clear();
            ShowMessage($"‚ùå Error cargando atributos de '{_selectedMetadataEntity}': {ex.Message}", "error");
        }
        finally
        {
            _isLoadingMetadata = false;
            StateHasChanged();
        }
    }

    private async Task LoadSelectedEntityAttributes(DataverseServiceClient client, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(_selectedMetadataEntity))
        {
            _availableAttributes.Clear();
            return;
        }

        var request = new RetrieveEntityRequest
        {
            LogicalName = _selectedMetadataEntity,
            EntityFilters = EntityFilters.Attributes,
            RetrieveAsIfPublished = true
        };

        var response = await Task.Run(
            () => (RetrieveEntityResponse)client.Execute(request),
            cancellationToken);

        var attributes = response.EntityMetadata?.Attributes?
            .Select(a => a.LogicalName)
            .Where(name => !string.IsNullOrWhiteSpace(name))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(name => name, StringComparer.OrdinalIgnoreCase)
            .ToList() ?? new List<string>();

        _availableAttributes.Clear();
        _availableAttributes.AddRange(attributes);
    }

    private async Task<DataverseServiceClient> CreateServiceClientAsync(CancellationToken cancellationToken)
    {
        var authProvider = BuildAuthenticationProvider();

        if (_authType == "oauth2" && string.Equals(_oauthFlow, "interactive", StringComparison.OrdinalIgnoreCase))
        {
            var interactiveConnectionString = BuildInteractiveConnectionString();
            var interactiveClient = new DataverseServiceClient(interactiveConnectionString);

            if (!interactiveClient.IsReady)
            {
                throw new InvalidOperationException(
                    string.IsNullOrWhiteSpace(interactiveClient.LastError)
                        ? "No se pudo completar login interactivo."
                        : interactiveClient.LastError);
            }

            return interactiveClient;
        }

        var token = await authProvider.GetAccessTokenAsync(cancellationToken);
        if (string.IsNullOrWhiteSpace(token))
        {
            throw new InvalidOperationException("No se obtuvo un token v√°lido para Dataverse.");
        }

        var connectionString =
            $"AuthType=OAuth;Url={AuthConfig.EnvironmentUrl};AccessToken={token};RequireNewInstance=True";
        var client = new DataverseServiceClient(connectionString);

        if (!client.IsReady)
        {
            throw new InvalidOperationException(
                string.IsNullOrWhiteSpace(client.LastError)
                    ? "El cliente Dataverse no est√° listo."
                    : client.LastError);
        }

        return client;
    }

    private string BuildInteractiveConnectionString()
    {
        var appId = string.IsNullOrWhiteSpace(AuthConfig.ClientId)
            ? OAuth2AuthenticationProvider.DefaultPublicClientAppId
            : AuthConfig.ClientId;

        return $"AuthType=OAuth;Url={AuthConfig.EnvironmentUrl};AppId={appId};RedirectUri={OAuth2AuthenticationProvider.DefaultPublicClientRedirectUri};LoginPrompt=Auto;RequireNewInstance=True;";
    }

    private IAuthenticationProvider BuildAuthenticationProvider()
    {
        AuthConfig.Validate();

        return AuthConfig.Type switch
        {
            DomainAuthenticationType.OAuth2 => new OAuth2AuthenticationProvider(
                AuthConfig,
                ServiceProvider.GetRequiredService<AuditHistoryExtractorPro.Domain.Interfaces.ILogger<OAuth2AuthenticationProvider>>(),
                OnDeviceCodeReceived),

            DomainAuthenticationType.ClientSecret => new ClientSecretAuthenticationProvider(
                AuthConfig,
                null,
                ServiceProvider.GetRequiredService<AuditHistoryExtractorPro.Domain.Interfaces.ILogger<ClientSecretAuthenticationProvider>>()),

            DomainAuthenticationType.Certificate => new CertificateAuthenticationProvider(
                AuthConfig,
                ServiceProvider.GetRequiredService<AuditHistoryExtractorPro.Domain.Interfaces.ILogger<CertificateAuthenticationProvider>>()),

            DomainAuthenticationType.ManagedIdentity => new ManagedIdentityAuthenticationProvider(
                AuthConfig,
                ServiceProvider.GetRequiredService<AuditHistoryExtractorPro.Domain.Interfaces.ILogger<ManagedIdentityAuthenticationProvider>>()),

            _ => throw new NotSupportedException($"Authentication type {AuthConfig.Type} is not supported")
        };
    }

    private void SyncAuthConfigurationFromForm()
    {
        AuthConfig.EnvironmentUrl = _environmentUrl.Trim();
        AuthConfig.TenantId = string.IsNullOrWhiteSpace(_tenantId) ? null : _tenantId.Trim();
        AuthConfig.ClientId = string.IsNullOrWhiteSpace(_clientId) ? null : _clientId.Trim();
        AuthConfig.ClientSecret = string.IsNullOrWhiteSpace(_clientSecret) ? null : _clientSecret.Trim();
        AuthConfig.CertificatePath = string.IsNullOrWhiteSpace(_certificatePath) ? null : _certificatePath.Trim();

        AuthConfig.Type = _authType switch
        {
            "oauth2" => DomainAuthenticationType.OAuth2,
            "client_secret" => DomainAuthenticationType.ClientSecret,
            "certificate" => DomainAuthenticationType.Certificate,
            "managed_identity" => DomainAuthenticationType.ManagedIdentity,
            _ => DomainAuthenticationType.OAuth2
        };

        AuthConfig.AdditionalParameters ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        AuthConfig.AdditionalParameters["AuthFlow"] = _oauthFlow;
    }

    private void OnDeviceCodeReceived(DeviceCodeChallengeInfo challenge)
    {
        _deviceCodeUserCode = challenge.UserCode;
        _deviceCodeMessage = challenge.Message;

        ShowMessage(
            $"C√≥digo recibido: {challenge.UserCode}. Abre microsoft.com/devicelogin e ingr√©salo para continuar.",
            "info");

        _ = InvokeAsync(StateHasChanged);
    }

    private void ShowConfigYaml()
    {
        _generatedYaml = GenerateYamlConfig();
        _showYaml = true;
        StateHasChanged();
    }

    private void CloseYamlPreview()
    {
        _showYaml = false;
        StateHasChanged();
    }

    private void AddAccount()
    {
        if (string.IsNullOrWhiteSpace(_accountName))
        {
            ShowMessage("Por favor ingresa un nombre para esta cuenta", "error");
            return;
        }

        if (string.IsNullOrWhiteSpace(_environmentUrl))
        {
            ShowMessage("Por favor configura la URL del entorno primero", "error");
            return;
        }

        _savedAccounts.Add(new SavedAccount
        {
            Name = _accountName,
            Url = _environmentUrl,
            AuthType = _authType.ToUpper()
        });

        ShowMessage($"‚úì Cuenta '{_accountName}' agregada correctamente", "success");
        _accountName = "";
        StateHasChanged();
    }

    private void LoadAccount(SavedAccount account)
    {
        _environmentUrl = account.Url;
        _authType = account.AuthType.ToLower();
        _activeTab = 0; // Cambiar a pesta√±a de Dataverse
        ShowMessage($"‚úì Configuraci√≥n '{account.Name}' cargada", "success");
        StateHasChanged();
    }

    private void DeleteAccount(SavedAccount account)
    {
        _savedAccounts.Remove(account);
        ShowMessage($"‚úì Cuenta '{account.Name}' eliminada", "success");
        StateHasChanged();
    }

    private void SaveAdvancedSettings()
    {
        ShowMessage("‚úì Configuraci√≥n avanzada guardada correctamente", "success");
        StateHasChanged();
    }

    private void ResetToDefaults()
    {
        _maxParallelRequests = 10;
        _pageSize = 5000;
        _enableCaching = true;
        _cacheDuration = 30;
        _enableKeyVault = false;
        _keyVaultUrl = "";
        ShowMessage("üîÑ Valores restaurados a configuraci√≥n por defecto", "success");
        StateHasChanged();
    }

    private void ShowMessage(string message, string type)
    {
        _message = message;
        _messageType = type;
        StateHasChanged();
    }

    private string GenerateYamlConfig()
    {
        return $@"# Audit History Extractor Pro - Configuraci√≥n
# Generado: {DateTime.Now:yyyy-MM-dd HH:mm:ss}

dataverse:
  environment_url: ""{_environmentUrl}""
  auth_type: ""{_authType}""
    oauth_flow: ""{_oauthFlow}""
  tenant_id: ""{_tenantId}""
  client_id: ""{_clientId}""
  
performance:
  max_parallel_requests: {_maxParallelRequests}
  page_size: {_pageSize}
  enable_caching: {_enableCaching.ToString().ToLower()}
  cache_duration_minutes: {_cacheDuration}

azure:
  key_vault:
    enabled: {_enableKeyVault.ToString().ToLower()}
    vault_url: ""{_keyVaultUrl}""";
    }

    private class SavedAccount
    {
        public string Name { get; set; } = "";
        public string Url { get; set; } = "";
        public string AuthType { get; set; } = "";
    }
}

<style>
    .settings-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        border-bottom: 2px solid #EDEBE9;
    }

    .tab {
        padding: 15px 30px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #605E5C;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .tab:hover {
        color: #0078D4;
        background: #F3F9FD;
    }

    .tab.active {
        color: #0078D4;
        border-bottom-color: #0078D4;
        background: #F3F9FD;
    }

    .tab-content {
        background: white;
        padding: 35px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .settings-section h2 {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    label {
        display: block;
        color: #323130;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .form-input, select {
        width: 100%;
        padding: 12px;
        border: 2px solid #EDEBE9;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .form-input:focus, select:focus {
        outline: none;
        border-color: #0078D4;
        box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
    }

    small {
        display: block;
        color: #605E5C;
        font-size: 12px;
        margin-top: 5px;
    }

    .checkbox-label-large {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        font-weight: 600;
        color: #323130;
        font-size: 16px;
    }

    .checkbox-label-large input[type="checkbox"] {
        width: 22px;
        height: 22px;
        cursor: pointer;
        accent-color: #0078D4;
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        flex-wrap: wrap;
    }

    .btn-primary, .btn-secondary, .btn-info, .btn-success {
        padding: 14px 28px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #0078D4;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: #106EBE;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
    }

    .btn-secondary {
        background: #EDEBE9;
        color: #323130;
    }

    .btn-secondary:hover {
        background: #E1DFDD;
        transform: translateY(-2px);
    }

    .btn-info {
        background: #00B7C3;
        color: white;
    }

    .btn-info:hover:not(:disabled) {
        background: #00A0AC;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 183, 195, 0.3);
    }

    .btn-success {
        background: #107C10;
        color: white;
    }

    .btn-success:hover {
        background: #0E6B0E;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 124, 16, 0.3);
    }

    .btn-primary:disabled, .btn-info:disabled {
        background: #A19F9D;
        cursor: not-allowed;
        transform: none;
    }

    .message-success, .message-error, .message-info {
        padding: 15px 20px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .message-success {
        background: #DFF6DD;
        border-left: 4px solid #107C10;
        color: #107C10;
    }

    .message-error {
        background: #FDE7E9;
        border-left: 4px solid #E81123;
        color: #A80000;
    }

    .message-info {
        background: #F3F9FD;
        border-left: 4px solid #0078D4;
        color: #0078D4;
    }

    .yaml-preview {
        margin-top: 30px;
        padding: 25px;
        background: #F3F2F1;
        border-radius: 8px;
        border-left: 4px solid #5C2D91;
    }

    .yaml-preview pre {
        background: #323130;
        color: #50E6FF;
        padding: 20px;
        border-radius: 4px;
        overflow-x: auto;
        font-family: 'Consolas', 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
    }

    .table-container {
        overflow-x: auto;
        margin: 20px 0;
    }

    .accounts-table {
        width: 100%;
        border-collapse: collapse;
    }

    .accounts-table th {
        background: #F3F2F1;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #323130;
        border-bottom: 2px solid #EDEBE9;
    }

    .accounts-table td {
        padding: 15px;
        border-bottom: 1px solid #EDEBE9;
        color: #323130;
    }

    .accounts-table tbody tr:hover {
        background: #F3F9FD;
    }

    .badge {
        background: #E1DFDD;
        color: #323130;
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .btn-action {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        margin-right: 8px;
        transition: all 0.2s;
    }

    .btn-edit {
        background: #0078D4;
        color: white;
    }

    .btn-edit:hover {
        background: #106EBE;
        transform: translateY(-1px);
    }

    .btn-delete {
        background: #E81123;
        color: white;
    }

    .btn-delete:hover {
        background: #C50F1F;
        transform: translateY(-1px);
    }

    .empty-state-small {
        text-align: center;
        padding: 40px 20px;
        background: #F3F2F1;
        border-radius: 8px;
        color: #605E5C;
    }

    .performance-stats {
        background: #F3F9FD;
        padding: 25px;
        border-radius: 8px;
        margin-top: 30px;
        border-left: 4px solid #0078D4;
    }

    .stats-grid-small {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        background: white;
        border-radius: 4px;
    }

    .stat-label {
        color: #605E5C;
        font-size: 14px;
    }

    .stat-value {
        color: #323130;
        font-weight: 700;
        font-size: 14px;
    }
</style>
